---

title: 网络协议栈

layout: post

---

* [物理层](#phys)
* [数据链路层](#link)
* [网络层](#inte)
* [传输层](#tran)
* [应用层](#appl)

结合OSI和TCP/IP的五层协议栈

* **物理层**：如何在一条通信信道上传输原始**比特**，确定与传输介质有关的机械特性、电气特性、功能特性和规程特性

* **数据链路层**：如何把数据组织成帧以及如何在网络中传输**帧**

* **网络层**：如何分配地址，如何把**数据包**从网络的一端传输到另一端

* **传输层**：如何处理可靠传输的细节

* **应用层**：应用程序如何使用网络

注：TCP/IP模型将OSI的应用层、表示层和会话层合并为应用层

<h2 id="phys">1，物理层</h2>

物理层是所有网络的基础，物理性质决定了所有信道必须遵循尼奎斯特抽样定理和香农定理，这也决定了它们的带宽。

带宽/brandwidth：（模拟）带宽是以 赫兹/Hz 来度量的；（数字）带宽则表示一个信道的最大数据速率，以 每秒多少比特/bps 来度量。

尼奎斯特抽样定理：在带宽为 B 的传输系统上的最大数据传输速率为 2B，更一般的情况是，如果传输系统使用K种不同电压（而非两种）进行数据编码，则最大传输速率为 2Blog2K。

实际通信系统中总会受到噪声干扰，香农定理：对一条带宽为 B Hz，信噪比是 S/N 的有噪声信道，最大数据传输速率为 Blog2(1+S/N)。

**传输介质**

传输介质分为引导性（即有线）和非引导性（无线）介质。主要的引导性介质有双绞线、同轴电缆和光纤；非引导性介质包括无线电、微波、红外线、激光和卫星。

双绞线：两根铜线螺旋绞绕，这样更能降低噪声。总共有1-7类，其中使用最多的为5类线，而1到6类都为非屏蔽双绞线，7类线为昂贵的屏蔽双绞线。

同轴电缆：分为50欧姆和75欧姆，50欧姆常用于数字传输；75欧姆常用于模拟传输和有线电视。

光纤：分为多模光纤和单模光纤（昂贵），传输速率高。

**数字调制与多路复用**

数字调制通过介质上的模拟信号来发送比特，是将比特转换成代表他们的信号的过程。对信号以基带方式进行线性编码后通过调幅、调频和调相等方式放到通带上传送。

1、基带传输：信号的传输占有传输介质上从零到最大值之间的全部频率。

数字调制最直接的形式为用正电压表示1，负电压表示0。如近距离异步串行通信的RS-232标准（正负15V）。

2、通带传输：信号占据了以载波信号频率为中心的一段频带。

采用载波进行调制可以使信号传得更远，一般分为调幅、调频和调相。

3、通信的方式可分为单工通信、半双工通信和全双工通信。

4、复用可以分为频分复用FDM（多个不同频率的信号共享同一信道）、时分复用TDM（不同信号以循环的方式轮流使用信道）和码分复用CDM（扩展频谱，把窄带信号扩展到一个宽的频带上）。

<h2 id="link">2，数据链路层</h2>

数据链路层从源机器的网络层取得数据并打包成帧传输到目标机器的网络层。

数据链路层根据需要可提供三种服务：无确认的无连接服务（如以太网）、有确认的无连接服务（如802.11无线网）和有确认的有连接服务（如卫星通信）。

数据成帧方法有以下四个：字节计数法（利用头部的一个字段来标识该帧字符数，易出错）、字节填充的标志字节法（帧前后加入特殊的字节标志）、比特填充的标志比特法（常用）和物理层编码违禁法。

**差错检测和纠正**

错误处理的两种策略：纠错码和检错码。前者通过在每一个数据块中加入足够多的冗余信息，以便接收方可以据此推断出被发送到数据；后者只需加入一些能让接收方判断是否发生错误的冗余，后接收方可以请求重传。

纠错码常用于容易出错的无线链路，包括海明码、二进制卷积码、里德所罗门码和低密度奇偶校验码。

检错码则用于错误率低的链路，包括奇偶校验、校验和和**循环冗余校验**。

**局域网技术与网络拓扑**

计算机通信分为直接点对点通信和共享信道通信。

局域网拓扑结构：星型拓扑如ATM、环型拓扑如令牌环、总线型拓扑如以太网。

以太网采用曼彻斯特编码，不像RS232检测固定的电压值，而是检测电压的变化，上升沿编码为1，下降沿编码为0。

以太网采用的协调传输机制是带冲突检测的载波侦听多址接入CSMA/CD，计算机在发送帧之前要等待以太网空闲，若两台计算机同时发送会产生冲突，此时计算机采用指数退避法选择哪台计算机发送。每台计算机在尝试再次发送之前都要延迟一段随机时间，这个时间在随后的每次冲突都会加倍。

无线局域网采用协调传输机制是避免冲突的载波侦听多址接入CSMA/CA，它不依赖于所有计算机都能接受到传输，而是在传输一个分组前由接收者发送很短的控制报文。

以太网帧格式：8前导序列 + 6目标地址 + 6源地址 + 2帧类型 + 46-1500帧中数据 + 4CRC = 72-1526字节

* 前导序列用于同步，每个字节包含比特模式10101010（除最后一个字节的后两位为11）。

* 目标地址第一位是0则为普通地址（单播），1则表示组地址（组播），全1的地址保留用作广播。

* 源地址是IEEE分配的全球唯一的物理地址/MAC地址。

**局域网扩展技术**

* 中继器：物理层设备。接收一个网段的所有信号，放大并转发到另一个网段。

* 网桥：链路层设备。接受一个网段的完整且正确的帧并转发到另一个网段。

* 网桥回路会产生广播风暴，使用分布生成树算法可以解决这个问题。

* 集线器可以看成是多端口的中继器；交换机可以看成是多端口的网桥。

注：路由器是网络层的概念。

<h2 id="inte">3，网络层</h2>

全局服务要求通信系统允许任意两台计算机进行通信，即网络互连，它既可以基于面向连接的虚电路，也可以基于无连接的数据报。网络互连使用路由器来连接异构网络。

最广泛使用于网络层的协议是TCP/IP协议。IP协议为每台主机分配了一个唯一的与物理地址无关的IP地址，IP地址由前缀和后缀两部分组成，总共分为ABCDE五类，ABC为三个基本类用于分配主机地址，D用于组播，E类保留。

协议地址与硬件地址之间的映射过程叫地址解析，地址解析技术包括查表法（常用于广域网）、封闭式计算法（常用于动态编址网）和报文交换法（常用于静态编址网）。ARP协议规定请求报文是广播的，而响应报文是直接发送的，常用于32位IP地址跟48位以太网地址的解析。

IP数据报是一种与底层无关的互联网分组格式，其头部包含的是IP地址，传输时会将数据报封装到帧里，帧的目的地址为数据报应送往的下一站MAC地址，而数据报中的IP地址始终为最终目的IP地址。

数据报的长度不能大于所经网络的最大传输单元MTU，因此常常会进行分片与重装。

因为是无连接服务，数据报传输过程中会发生丢失、重复、延迟和乱序等问题。互联网控制报文协议ICMP包括差错报文和信息报文，ICMP报文通过封装进IP报文进行传输，常用于测试可达性ping、跟踪路径tracert、发现通路MTU。

服务质量：吞吐量、时延（分组时延、排队时延、交换时延和传播时延）、抖动和漂移（都是时延变化）。

IP路由技术可以分为静态路由和动态路由，多数主机采用静态路由。

因特网路由协议包括内部网关协议IGP和外部网关协议EGP，每个自治系统中选择使用各自的IGP，两个自治系统AS的两个边界路由器通过EGP进行传输。流行的内部网关协议有路由信息协议RIP（采用距离矢量算法）和开放最短通路优先协议OSPF（采用链路状态算法），外部网关协议常用的有边界网关协议BGP。

<h2 id="tran">4，传输层</h2>

TCP/IP传输有两个协议：数据报协议UDP和传输控制协议TCP。

UDP是端到端、无连结、面向报文、尽力而为的。并且允许一对一、一对多、多对一和多对多交互通信。UDP可用于C/S交互，也可用于建立实时协议。

TCP是面向连结、点对点、可靠、全双工的。允许两个应用程序建立连结并在任一方向上发送数据，然后终止连结。

可靠的TCP协议要建立在不可靠的IP协议上，需要使用各种不同的技术。

最重要的技术是重传。重传是当发送方发送数据时会启动一个定时器，若超时之前未收到接收方收到数据的确认报文，则发送方会重新发送数据。自适应重传指的是发送方的等待时间是自适应的，会根据最近的报文往返时间进行加权平均结合方差计算。

TCP使用一种流量控制窗口（缓冲区）机制来控制数据流，防止发送方数据淹没接收方。

TCP还使用一种拥塞窗口，通过慢速启动慢慢增加拥塞窗口，当检测到丢包时迅速减小窗口，以防止拥塞崩溃。（网络拥塞使用分组丢失率衡量）

TCP的连结和建立都采用三次握手的方式。

<h2 id="appl">5，应用层</h2>

域名解析系统DNS将域名解析成对应的IP地址，CNAME为DNS提供了一个别名。

每个电子邮件地址都是唯一的用@符号隔开的，第一部分标识目标用户，第二部分表示目标用户所在的计算机地址。

电子邮件系统由发送端用户代理（如Outlook）提交邮件后，邮件传输代理使用协议（如SMTP）传送至目标邮件传输代理，并将最后邮件传递给接收端用户代理。

简单邮件传输协议SMTP用于在计算机之间传输电子邮件，SMTP使用ASCII文本来表示报文，可通过MIME标准进行扩展，允许电子邮件传输二进制数据。

Web文档使用超文本标记语言HTML编写，外部引用以统一资源定位符URL标识。URL包含协议、主机DNS域名和特定路径组成。如http://allenyip.com/index.html。

当浏览器输入一个URL并回车时，页面的显示要经历以下步骤：

1. 浏览器确定URL，观察选中的什么

2. 浏览器请求DNS查询服务器allenyip.com的IP地址

3. DNS返回204.232.175.78

4. 浏览器与204.232.175.78机器的80端口建立一个TCP连接

5. 浏览器发送HTTP报文，请求/index.html页面

6. allenyip.com服务器发回页面作为HTTP响应

7. 若该页面包括需要显示的URL，如图片/视频等，那么浏览器经过同样处理获取其他URL

8. 浏览器显示/index.html页面

9. 若一段时间内没有向同一服务器发送其他请求，则释放TCP连接

一些常用URL协议：超文本传输协议http、安全的超文本传输协议https、FTP、本地文件file、发送邮件mailto、流式媒体rtsp、多媒体呼叫sip、浏览器信息about。

统一资源标识符URI是URL的推广，也是现在Web上地址的基本形式。某些URI告诉浏览器如何定位资源，这些URI就是URL，而一些URI只告诉了资源名称，没有说明如何找到它，这些URI称为统一资源名URN。（URI，URL是URI的子集）

HTML页面包含了丰富的资源，甚至是音频视频等不包含HTML的其他文件类型，通用的方案不是使浏览器越做越大兼容各个文件类型（这样做不仅不现实，还有很大的安全问题），而是通过服务器返回的页面的MIME，若为text/html类型则直接显示，否则查阅MIME列表以确定如何显示页面。（通常会通过插件和辅助应用程序）

服务器所做的工作比客户端简单：

1. 接受来自客户端/浏览器的TCP连接

2. 获取页面路径，即被请求文件的名字

3. 获取文件（从内存或磁盘中取，若为动态内容需要使用应用程序生成文件）

4. 将文件内容返回给客户

5. 检查是否释放TCP连接

为了解决一次只能服务一个请求的问题，服务器被设计成多线程模式，由一个前端模块和K个处理模块组成，这K+1个线程都属于同一进程，由前端模块接受请求后交给处理模块进行处理。每个请求的实际处理还包括以下几个步骤：

1. 解析被请求的Web页面的名字，如未加路径默认为index

2. 执行对该页面的访问控制，如是否具有权限，是否需要登录

3. 检查缓存

4. 从磁盘获取请求的页面或者运行一个创建页面的程序

5. 确定响应的其余部分，如要发送的MIME类型

6. 把响应返回给客户

7. 在服务器的日志中添加一个表项

Cookie是服务器和浏览器之间用于保存一些附加信息（如用户ID，购物车数据等），一般包含5个字段：域字段指出Cookie来自何方、路径字段标识服务器文件树的哪些部分可能使用到该Cookie（一般为/）、内容字段采用名字=值的方式存储、过期时间字段指定Cookie的生命（为空则在浏览器退出时丢弃）、安全字段指示浏览器只向使用安全传输连接（SSL/TLS）的服务器返回Cookie。

当浏览器访问动态内容时，为了使服务器能够调用程序，计算机提供了相应的API标准。动态页面请求有两种方法，第一种方法是**公共网关接口CGI**，CGI提供了一个允许Web服务器与后端程序及脚本通信，这些后端程序和脚本接受输入并生成HTML页面作为响应，可用Python, Ruby, Perl等脚本语言编写。第二种方法是在**HTML页面中嵌入脚本**，然后让服务器执行脚本生成返回给客户的页面。常用的有PHP，JSP和ASP。

超文本传输协议HTTP已经不仅仅适用于Web，HTTP1.1新增一些内置的请求方法如GET/POST、HEAD、PUT/DELETE使得HTTP协议变得越来越通用。每个请求都会得到一个包含状态码和附加信息的响应，状态码分为5组：

1. 1XX，信息，如100=服务器同意处理客户请求。

2. 2XX，成功，如200=请求成功、204=没有内容

3. 3XX，重定向，如301=移动页面、304=缓存页面

4. 4XX，客户错误，如403=禁止访问、404=页面没找到

5. 5XX，服务器错误，如500=服务器内部错误，503=稍后再试

SOAP是一种使用HTTP来发送XML消息的远程过程调用RPC机制。

内容分发网络CDN使用DNS把客户指向一个附近的服务器。

P2P网络让一组机器彼此共享内容。